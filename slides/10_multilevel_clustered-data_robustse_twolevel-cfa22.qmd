---
title: "Multilevel / clustered-data strategy"
subtitle: "Two-level CFA in lavaan: within vs between, robust SE, and cross-level invariance"
author: "Tommaso Feraco (adapted from Luca Menghini’s HandZone slides)"
date: "Doctoral School in Psychological Sciences - University of Padova"

bibliography: ../refs/references.bib
csl: ../refs/apa7.csl

format:
  revealjs:
    slide-number: c/t
    code-overflow: wrap
    code-line-numbers: false
    theme: [default, ../assets/css/theme.scss, ../assets/css/slides.scss]
    include-in-header: ../assets/slidesheader.html
    title-slide-attributes:
      data-background-image: "../assets/images/psicostatLogo.png"
      data-background-size: "contain"
      data-background-opacity: "0.15"

execute:
  echo: true
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false
library(lavaan)
library(semTools)
options(digits = 3)
set.seed(123)
```

## Today in the workflow

**Specify → Identify → Estimate → Evaluate → Revise/Report**

::: {.callout-note appearance="minimal"}
**Today:** cosa cambia quando i dati sono **nidificati** (cluster) o **ripetuti** (entro persona).  
Idea chiave: SEM/CFA partono da una matrice di covarianza; con dati clustered abbiamo **within** e **between**.
:::

## Learning objectives

- Riconoscere quando l’indipendenza è violata (cluster/repeated) e cosa succede se la ignori  
- Capire la decomposizione **within vs between** della (co)varianza  
- Specificare e stimare una **two-level CFA** in `lavaan` (`level:` + `cluster=`)  
- Leggere **fit livello-specifici** (SRMR within vs between)  
- Capire la logica dell’**invarianza cross-livello** (e i suoi limiti)

## Outline (come nel PDF)

- SEM, CFA e razionale della CFA multilivello  
- HandZone: come condurre una CFA multilivello con **lavaan**  
- Esempio pratico: **Gruppi e individui**  
- Esempi pratici: **Misure ripetute**  
- **Invarianza cross-livello**: dalla pratica alla teoria  

## Multilevel what!?

<span style="color:#c00000;">[INSERIRE FIGURA: “Multilevel what!?” (schema introduttivo dal PDF)]</span>

Idea: SEM = sistema di equazioni stimate simultaneamente.

Esempio (regressione “standard”):

$$
\text{PERF} = \beta_1 \text{IQ} + \beta_2 \text{ANX} + \epsilon
$$

Esempio (sistema SEM):

$$
\begin{aligned}
\text{ANX} &= \beta_1 \text{SEFF} + \epsilon_2\\
\text{PERF} &= \beta_2 \text{SEFF} + \beta_3 \text{ANX} + \epsilon_3
\end{aligned}
$$

## Le due parti fondamentali di un SEM

Un SEM include generalmente:

1) **Modello strutturale**: relazioni “regression-like” tra (latenti o osservate)  
2) **Modello di misurazione**: relazioni tra latenti e indicatori (CFA)

<span style="color:#c00000;">[INSERIRE FIGURA: “Le due parti fondamentali” (schema SEM dal PDF)]</span>

## Analisi fattoriale confermativa (CFA)

Una CFA include **solo** il modello di misurazione:

- definisce i fattori (latenti) e quali indicatori li misurano
- stima saturazioni, varianze residue, (co)varianze tra fattori
- valuta l’adattamento del modello a partire da \(S\) e \(\hat\Sigma(\theta)\)

<span style="color:#c00000;">[INSERIRE FIGURA: “CFA” / “Struttura fattoriale” dal PDF] </span>

## Punto di partenza: la matrice di covarianza

SEM/CFA partono dalla matrice di covarianza osservata \(S\):

$$
\mathrm{cov}(x,y) = \frac{\sum (x_i-\bar x)(y_i-\bar y)}{N}
$$

Il modello stima parametri \(\theta\) tali che:

- la matrice implicata \(\hat\Sigma(\theta)\) “assomigli” a \(S\)
- la differenza tra \(S\) e \(\hat\Sigma\) guida *fit* e diagnostica

## E se i dati sono multilivello?

Quando le osservazioni sono nidificate (cluster) o ripetute:

- si creano **dipendenze locali** (osservazioni nello stesso cluster più simili)
- si viola l’assunto di indipendenza
- ignorare la struttura può alterare **SE** e inferenza (e a volte anche stime)

Esempi:
- persone entro scuole/classi/team
- misure ripetute entro persone (ESM, longitudinali intensivi)

## Scomposizione within vs between (intuizione)

Possiamo decomporre la (co)varianza in:

- **Between (L2):** covarianza tra le *medie dei cluster*  
- **Within (L1):** covarianza tra gli *scarti dalla media del cluster*

Interpretazione:
- Between: cluster con media alta su X hanno media alta su Y?
- Within: unità “sopra la media del proprio cluster” su X sono anche sopra su Y?

## Come si ottengono (pseudo-codice)

```{r}
#| eval: false
# df: long data, cluster = id_cluster
wide <- aggregate(cbind(x1, x2) ~ cluster, data = df, FUN = mean)  # between means
df <- merge(df, wide, by = "cluster", suffixes = c("", ".b"))
df$x1.w <- df$x1 - df$x1.b
df$x2.w <- df$x2 - df$x2.b

S_between <- cov(wide[, c("x1","x2")])
S_within  <- cov(df[, c("x1.w","x2.w")])
```

## Multilevel CFA (idea)

La MCFA usa **due** strutture:

- fattori e residui a livello **within**
- fattori e residui a livello **between**

Obiettivo: capire se la struttura di misura è coerente a entrambi i livelli e valutare:
- saturazioni livello-specifiche
- varianze residue livello-specifiche
- fit livello-specifico

<span style="color:#c00000;">[INSERIRE FIGURA: “Multilevel CFA” (schema within/between) dal PDF]</span>

## HandZone: CFA con lavaan (recap veloce)

```{r}
#| eval: false
data(HolzingerSwineford1939, package = "lavaan")

m3 <- '
  visual  =~ x1 + x2 + x3
  textual =~ x4 + x5 + x6
  speed   =~ x7 + x8 + x9
'
m1 <- 'general =~ x1 + x2 + x3 + x4 + x5 + x6 + x7 + x8 + x9'

fit3 <- cfa(m3, data = HolzingerSwineford1939)
fit1 <- cfa(m1, data = HolzingerSwineford1939)
```

## Fit e confronto tra modelli (recap)

```{r}
#| eval: false
lavInspect(fit3, "fit")[c("chisq","df","rmsea","cfi","tli","srmr")]
lavInspect(fit1, "fit")[c("chisq","df","rmsea","cfi","tli","srmr")]
```

<span style="color:#c00000;">[INSERIRE FIGURA/TABELLA: confronto fit (come nel PDF)]</span>

## Multilevel CFA in lavaan: sintassi

Due ingredienti:

- blocchi `level: 1` e `level: 2`
- argomento `cluster = "ID"` in `cfa()` / `sem()`

```{r}
#| eval: false
m2l <- '
  level: 1
    TD_w =~ d1 + d2 + d3 + d4
  level: 2
    TD_b =~ d1 + d2 + d3 + d4
'

fit2l <- cfa(m2l, data = ESMdata, cluster = "ID")
```

<span style="color:#c00000;">[INSERIRE FIGURA: “MCFA con R (ESM)” / esempio HandZone dal PDF]</span>

## Fit livello-specifico (punto chiave pratico)

In MCFA:

- RMSEA/CFI/TLI sono spesso guidati dal **within** (molte più osservazioni a L1)
- SRMR è disponibile separatamente:
  - `srmr_within`
  - `srmr_between` (molto informativo per L2)

```{r}
#| eval: false
lavInspect(fit2l, "fit")[c("rmsea","cfi","tli","srmr_within","srmr_between")]
```

## Parametri livello-specifici

```{r}
#| eval: false
# within loadings (indicativo: righe iniziali)
standardizedSolution(fit2l)[1:4, ]

# between loadings (indicativo: righe successive)
standardizedSolution(fit2l)[15:18, ]
```

::: {.callout-note appearance="minimal"}
Nel PDF: nota che spesso le saturazioni between risultano più forti (Hox, 2010).
:::

## Esempio (gruppi): soggetti nidificati entro scuole/team

Quando soggetti sono reclutati in scuole/classi/organizzazioni:

- correlazioni più forti entro gruppo
- possibile componente “shared” (contesto / composizione)
- domanda: il costrutto esiste anche a livello gruppo?

<span style="color:#c00000;">[INSERIRE SLIDE: descrizione dataset “participation” (campione + 4 item) dal PDF]</span>

## Single-level CFA (MLR vs WLSMV)

<span style="color:#c00000;">[INSERIRE FIGURA: “Single-level CFA (MLR vs WLSMV)” dal PDF]</span>

## Modello preliminare L1: pooled-within (Hox, 2010)

Idea: fit della CFA sulla matrice pooled-within prima di passare al two-level.

```{r}
#| eval: false
lwd <- na.omit(edudata[, c("schoolID", paste0("p",2:5))])

ms <- data.frame(
  p2 = ave(lwd$p2, lwd$schoolID),
  p3 = ave(lwd$p3, lwd$schoolID),
  p4 = ave(lwd$p4, lwd$schoolID),
  p5 = ave(lwd$p5, lwd$schoolID)
)

cs <- lwd[, 2:ncol(lwd)] - ms

pw.cov <- (cov(cs) * (nrow(lwd) - 1)) / (nrow(lwd) - nlevels(lwd$schoolID))

m1 <- 'EP =~ p2 + p3 + p4 + p5'
fit_pw <- cfa(m1, sample.cov = pw.cov, sample.nobs = nrow(lwd))
lavInspect(fit_pw, "fit")[c("chisq","df","rmsea","cfi","tli","srmr")]
```

## Modelli preliminari L2: benchmark

Benchmark models (Hox):

1. **Null (L2)**: nessuna varianza a L2 (se va bene → poca struttura between)
2. **Independence (L2)**: solo varianze, niente covarianze
3. **Saturated (L2)**: L2 saturo (se necessario per fit → la struttura factor L2 non spiega bene)

```{r}
#| eval: false
m_null <- '
  level: 1
    p.w =~ p2 + p3 + p4 + p5
  level: 2
    p2 ~~ 0*p2
    p3 ~~ 0*p3
    p4 ~~ 0*p4
    p5 ~~ 0*p5
'

m_ind <- '
  level: 1
    p.w =~ p2 + p3 + p4 + p5
  level: 2
    p2 ~~ p2
    p3 ~~ p3
    p4 ~~ p4
    p5 ~~ p5
'

m_sat <- '
  level: 1
    p.w =~ p2 + p3 + p4 + p5
  level: 2
    p2 ~~ p2 + p3 + p4 + p5
    p3 ~~ p3 + p4 + p5
    p4 ~~ p4 + p5
    p5 ~~ p5
'
```

## MCFA: modello ipotizzato (1 fattore a entrambi i livelli)

```{r}
#| eval: false
m_mcfa <- '
  level: 1
    p.w =~ p2 + p3 + p4 + p5
  level: 2
    p.b =~ p2 + p3 + p4 + p5
'

fit_mcfa <- cfa(m_mcfa, data = edudata, cluster = "schoolID", estimator = "MLR")
```

<span style="color:#c00000;">[INSERIRE FIGURA: “MCFA: modello ipotizzato” dal PDF]</span>

## Saturazioni livello-specifiche + ω (idea dal PDF)

```{r}
#| eval: false
sl <- standardizedSolution(fit_mcfa)[c(1:4, 15:18), 1:6]

sl.w <- sl[1:4, "est.std"]; re.w <- 1 - sl.w^2
omega_w <- sum(sl.w)^2 / (sum(sl.w)^2 + sum(re.w))

sl.b <- sl[5:8, "est.std"]; re.b <- 1 - sl.b^2
omega_b <- sum(sl.b)^2 / (sum(sl.b)^2 + sum(re.b))

round(c(omega_within = omega_w, omega_between = omega_b), 2)
```

## Misure ripetute entro persona (ESM): stressor & strain

Dati ESM (misure ripetute):

- within-person = fluttuazioni “state”
- between-person = differenze stabili “trait-like”

<span style="color:#c00000;">[INSERIRE FIGURA: “stressor e strain” (design ESM) dal PDF]</span>

## Strutture alternative within/between (più fattori)

Idea: confrontare dimensionalità diversa tra livelli (3×3, 2×3, 2×2, 3×2).

```{r}
#| eval: false
m3x3 <- '
  level: 1
    NV_w =~ v1 + v2 + v3
    TA_w =~ t1 + t2 + t3
    FA_w =~ f1 + f2 + f3
  level: 2
    NV_b =~ v1 + v2 + v3
    TA_b =~ t1 + t2 + t3
    FA_b =~ f1 + f2 + f3
'

m2x3 <- '
  level: 1
    NV_w =~ v1 + v2 + v3
    TA_w =~ t1 + t2 + t3
    FA_w =~ f1 + f2 + f3
  level: 2
    NV_b =~ v1 + v2 + v3 + t1 + t2 + t3
    FA_b =~ f1 + f2 + f3
'

m2x2 <- '
  level: 1
    NV_w =~ v1 + v2 + v3 + t1 + t2 + t3
    FA_w =~ f1 + f2 + f3
  level: 2
    NV_b =~ v1 + v2 + v3 + t1 + t2 + t3
    FA_b =~ f1 + f2 + f3
'

m3x2 <- '
  level: 1
    NV_w =~ v1 + v2 + v3 + t1 + t2 + t3
    FA_w =~ f1 + f2 + f3
  level: 2
    NV_b =~ v1 + v2 + v3
    TA_b =~ t1 + t2 + t3
    FA_b =~ f1 + f2 + f3
'
```

<span style="color:#c00000;">[INSERIRE FIGURA: “MCFA con più di un fattore / strutture alternative” dal PDF]</span>

## Varianze negative a livello 2 (Heywood cases)

Nel two-level CFA possono apparire varianze residue negative a L2:

- spesso perché la varianza residua vera è ~0 a L2
- oppure per misspecification / campione piccolo a livello cluster

Nel PDF: discussione + citazione (Kolenikov & Bollen, 2012).

```{r}
#| eval: false
p <- parameterEstimates(fit3x3)
p[p$op == "~~" & p$ci.lower < 0, ]
```

<span style="color:#c00000;">[INSERIRE SLIDE: “Analisi casi influenti” dal PDF (lista ID rimossi)]</span>

## Invarianza cross-livello (idea)

Con molti cluster, la MG-CFA classica è impraticabile.  
Si può testare se la misura è “simile” tra within e between: **cross-level invariance**.

<span style="color:#c00000;">[INSERIRE FIGURE: “Invarianza tra gruppi / tra cluster!?” dal PDF]</span>

## Cross-level invariance: configurale

Stessa struttura fattoriale a livello 1 e 2.

```{r}
#| eval: false
conf <- '
  level: 1
    NV_w =~ v1 + v2 + v3
    TA_w =~ t1 + t2 + t3
    FA_w =~ f1 + f2 + f3
  level: 2
    NV_b =~ v1 + v2 + v3
    TA_b =~ t1 + t2 + t3
    FA_b =~ f1 + f2 + f3
'
```

## Cross-level invariance: debole (loadings uguali)

```{r}
#| eval: false
weak <- '
  level: 1
    NV_w =~ a*v1 + b*v2 + c*v3
    TA_w =~ d*t1 + e*t2 + f*t3
    FA_w =~ g*f1 + h*f2 + i*f3
  level: 2
    NV_b =~ a*v1 + b*v2 + c*v3
    TA_b =~ d*t1 + e*t2 + f*t3
    FA_b =~ g*f1 + h*f2 + i*f3
'
```

## Cross-level invariance: “forte” (nota dal PDF)

Nel deck originale: oltre ai loadings uguali, residui L2 fissati a 0 (attendibilità perfetta).  
In psicologia spesso è un benchmark teorico più che un default.

```{r}
#| eval: false
strong <- '
  level: 1
    NV_w =~ a*v1 + b*v2 + c*v3
    TA_w =~ d*t1 + e*t2 + f*t3
    FA_w =~ g*f1 + h*f2 + i*f3
  level: 2
    NV_b =~ a*v1 + b*v2 + c*v3
    TA_b =~ d*t1 + e*t2 + f*t3
    FA_b =~ g*f1 + h*f2 + i*f3

    v1 ~~ 0*v1; v2 ~~ 0*v2; v3 ~~ 0*v3
    t1 ~~ 0*t1; t2 ~~ 0*t2; t3 ~~ 0*t3
    f1 ~~ 0*f1; f2 ~~ 0*f2; f3 ~~ 0*f3
'
```

## Confronto modelli (fit)

```{r}
#| eval: false
fit.conf   <- cfa(conf,   clean, cluster = "ID")
fit.weak   <- cfa(weak,   clean, cluster = "ID")
fit.strong <- cfa(strong, clean, cluster = "ID")

f <- c("df","rmsea","cfi","srmr_within","srmr_between")
round(rbind(
  conf   = lavInspect(fit.conf,   "fit")[f],
  weak   = lavInspect(fit.weak,   "fit")[f],
  strong = lavInspect(fit.strong, "fit")[f]
), 3)
```

<span style="color:#c00000;">[INSERIRE FIGURA/TABELLA: confronto modelli (come nel PDF)]</span>

## Costrutti multilivello e omologia cross-livello

Messaggio finale del PDF:

- within e between possono rappresentare “lo stesso” costrutto (omologia) oppure costrutti differenti
- l’invarianza cross-livello aiuta a sostenere interpretazioni trait/state

<span style="color:#c00000;">[INSERIRE FIGURE FINALI: costrutti multilivello, tratti/stati, workaholism (dal PDF)]</span>

## Exercises → Lab 10

Vai a:

- **`labs/lab10_multilevel_robustse_twolevelcfa.qmd`**

Cose che farai:

1. Specificare un modello 2-livelli (`level:` + `cluster=`)  
2. Confrontare strutture alternative within/between  
3. Leggere `srmr_within` vs `srmr_between` e diagnosticare Heywood a livello 2  
4. (Opzionale) impostare cross-level invariance e confrontare modelli

## Take-home: 3 things

1. Con dati nidificati, pensa sempre **within vs between** (decomposizione della covarianza)  
2. In MCFA, usa indici livello-specifici (spec. **SRMR_between**) e controlla Heywood cases a lv2  
3. L’**invarianza cross-livello** collega pratica (fit) e teoria (che cosa “è” il costrutto a lv2)

## Further reading

- Hox, J. (2010). *Multilevel Analysis* (cap. su SEM/MCFA)  
- Stapleton et al. (2016) su costrutti multilivello e cross-level invariance  
- Kolenikov & Bollen (2012) su varianze negative / soluzioni improprie in MCFA

## References

<span style="color:#c00000;">[INSERIRE: citazioni dal PDF in refs/references.bib]</span>
